import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.scoreboard.*;

import java.util.HashMap;
import java.util.Map;

public class CatPlanetScoreboard extends JavaPlugin implements Listener {

    // Initialize scoreboard, objective, and a map to keep track of teams.
    private Scoreboard board;
    private Objective obj;
    private Map<String, Team> teams = new HashMap<>();
    
    // These strings will hold the title and content for the scoreboard, loaded from the config.
    private String title;
    private String content;

    @Override
    public void onEnable() {
        // Save the default config if it doesn't exist.
        saveDefaultConfig();
        
        // Reload the config to initialize the title and content.
        reloadConfig();
        
        // Setup the scoreboard and register this plugin as a listener for events.
        setupScoreboard();
        Bukkit.getPluginManager().registerEvents(this, this);
        
        // Register a listener for when players join to automatically add them to the scoreboard.
        // Note: This is a new addition, as the original code did not handle PlayerJoinEvent.
        getServer().getPluginManager().registerEvents(new PlayerJoinListener(), this);
    }

    // This method sets up the scoreboard, objective, and team.
    private void setupScoreboard() {
        board = Bukkit.getScoreboardManager().getNewScoreboard();
        obj = board.registerNewObjective("catPlanet", "dummy");
        obj.setDisplaySlot(DisplaySlot.SIDEBAR);
        obj.setDisplayName(title); // Set the display name of the objective based on the title from the config.

        // Register a new team and set its prefix based on the content from the config.
        Team team = board.registerNewTeam("teamWelcome");
        team.setPrefix(content);
        
        teams.put("teamWelcome", team);

        // Iterate through all online players, add them to the team, and set their scoreboard to the new one.
        Bukkit.getOnlinePlayers().forEach(player -> {
            team.addEntry(player.getName());
            player.setScoreboard(board);
        });
    }

    // This method reloads the configuration and sets the title and content based on the config.
    private void reloadConfig() {
        this.title = getConfig().getString("scoreboard.title", "猫猫星球");
        this.content = getConfig().getString("scoreboard.content", "欢迎游玩");
    }

    // New listener class to handle PlayerJoinEvent.
    private class PlayerJoinListener implements Listener {
        @EventHandler
        public void onPlayerJoin(PlayerJoinEvent event) {
            // When a player joins, add them to the team and set their scoreboard to the plugin's scoreboard.
            Team team = teams.get("teamWelcome");
            if (team != null) {
                team.addEntry(event.getPlayer().getName());
                event.getPlayer().setScoreboard(board);
            }
        }
    }
}