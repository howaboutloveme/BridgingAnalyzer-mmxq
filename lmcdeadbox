// 导入必要的包
import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Chest;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.PlayerDeathEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.plugin.java.JavaPlugin;

public class DeathChestPlugin extends JavaPlugin implements Listener {

    @Override
    public void onEnable() {
        // 当插件启用时，注册监听器
        Bukkit.getPluginManager().registerEvents(this, this);
    }

    @Override
    public void onDisable() {
        // 当插件停用时的清理工作
    }

    // 监听玩家死亡事件
    @EventHandler
    public void onPlayerDeath(PlayerDeathEvent event) {
        Player player = event.getEntity(); // 获取死亡的玩家
        Location deathLocation = player.getLocation(); // 获取玩家死亡的位置

        // 检查位置是否安全，避免生成在空中或实体中
        if (isLocationSafe(deathLocation)) {
            // 在玩家死亡的位置生成一个箱子
            Chest chest = generateChest(deathLocation);
            // 将玩家背包内的物品转移到箱子中
            transferItemsToChest(chest, player);
            // 清空玩家背包
            player.getInventory().clear();
        }
    }

    // 检查位置是否安全
    private boolean isLocationSafe(Location location) {
        // 检查玩家死亡位置下方的方块是否为草地，以判断是否安全
        return location.getBlock().getRelative(0, -1, 0).getType() == Material.GRASS_BLOCK;
    }

    // 在给定位置生成箱子
    private Chest generateChest(Location location) {
        Chest chest = (Chest) location.getWorld().spawn(location, Chest.class);
        return chest;
    }

    // 将玩家物品转移到箱子
    private void transferItemsToChest(Chest chest, Player player) {
        // 把玩家背包内的所有物品转移到生成的箱子中
        chest.getBlockInventory().setContents(player.getInventory().getContents());
    }
}